-----------------Логическая репликация


----Настройка мастера


docker exec -it postgreSQL1 bash


su postgres

psql


ALTER SYSTEM SET wal_level = logical;

Перезапустить контейнер

show wal_level;  //просмотр, какая реплика


![Просмотр логич реплика](Просмотр%20логич%20реплика.png)


создаём публикацию на мастере


psql

CREATE USER repluser WITH REPLICATION ENCRYPTED PASSWORD 'repluser2';  //создаем пользователя с правами реплики

!!!!У меня уже создан такой пользователь


\c new_year_decoration  //перейти в базу данных


GRANT ALL ON country_manufactures TO repluser;  //пользователь repluser получает все права на таблицу country_manufactures


-------------Создание таблицы "Страна производителя"


CREATE TABLE country_manufactures
(
    id_country int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name_country character varying(32) NOT NULL
);


\dt  //просмотреть таблицы


SELECT * FROM country_manufactures;


CREATE PUBLICATION test_pub FOR TABLE country_manufactures;  //создание публикации


\dRp+   //просмотр созданной публикации


![Просмотр публикации](Просмотр%20публикации.png)


-----Настройка репликации


docker run --name postgreSQL3 -e POSTGRES_PASSWORD=postgres3 -d -p 5434:5432 postgres  //создаем 3-й контейнер


docker exec -it postgreSQL3 bash  //подключаемся к 3 контейнеру


apt-get update

apt-get -y install nano


su postgres

psql


ALTER SYSTEM SET wal_level = logical;

Перезапустить контейнер

show wal_level;  //просмотр, какая реплика


![Просмотр логич реплика2](Просмотр%20логич%20реплика2.png)


CREATE DATABASE new_year_decoration;

\c new_year_decoration  //перейти в базу данных


-------------Создание таблицы "Страна производителя"


CREATE TABLE country_manufactures
(
    id_country int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name_country character varying(32) NOT NULL
);



----Создаем подписку


CREATE SUBSCRIPTION test_sub
CONNECTION 'host=172.17.0.2 port=5432 user=repluser password=repluser2 dbname=new_year_decoration' 
PUBLICATION test_pub WITH (copy_data = true);


SELECT * FROM country_manufactures;



----В 1-ом контейнере

--Добавление данных в таблицу "Страна производителя"

INSERT INTO country_manufactures
(name_country)
VALUES ('Вьетнам'),
       ('Россия'),
       ('Китай');


SELECT * FROM country_manufactures;


![Все права repluser](Все%20права%20repluser.png)


-----Во 2-ом контейнере

SELECT * FROM country_manufactures;   //Проверяем, что все работает

SELECT * FROM pg_stat_subscription \gx


![Проверка подписки](Проверка%20подписки%20в%203%20конт.png)

